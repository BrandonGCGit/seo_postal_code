---
import { postalCodes } from '../utils/data';

// Generate search data for autocomplete
const searchData = postalCodes.map(entry => ({
  label: `${entry.district}, ${entry.canton}, ${entry.province}`,
  value: entry.postal_code,
  url: `/codigo-postal/${entry.province.toLowerCase().replace(/\s+/g, '-').normalize('NFD').replace(/[\u0300-\u036f]/g, '')}/${entry.canton.toLowerCase().replace(/\s+/g, '-').normalize('NFD').replace(/[\u0300-\u036f]/g, '')}/${entry.district.toLowerCase().replace(/\s+/g, '-').normalize('NFD').replace(/[\u0300-\u036f]/g, '')}/`
}));
---

<div class="max-w-2xl mx-auto">
  <div class="relative">
    <input
      type="text"
      id="search-input"
      placeholder="Buscar por provincia, cantón, distrito o código postal..."
      class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      autocomplete="off"
    />
    <div id="search-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto">
    </div>
  </div>
</div>

<script define:vars={{ searchData }}>
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');
  
  let currentFocus = -1;
  
  searchInput.addEventListener('input', function(e) {
    const value = e.target.value.toLowerCase();
    currentFocus = -1;
    
    if (value.length < 2) {
      searchResults.classList.add('hidden');
      return;
    }
    
    const filtered = searchData.filter(item => 
      item.label.toLowerCase().includes(value) || 
      item.value.includes(value)
    ).slice(0, 10);
    
    if (filtered.length === 0) {
      searchResults.classList.add('hidden');
      return;
    }
    
    searchResults.innerHTML = filtered.map((item, index) => 
      `<div class="search-item px-4 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" data-url="${item.url}">
        <div class="font-medium">${item.label}</div>
        <div class="text-sm text-gray-600">Código postal: ${item.value}</div>
      </div>`
    ).join('');
    
    searchResults.classList.remove('hidden');
    
    // Add click handlers
    document.querySelectorAll('.search-item').forEach(item => {
      item.addEventListener('click', function() {
        window.location.href = this.dataset.url;
      });
    });
  });
  
  searchInput.addEventListener('keydown', function(e) {
    const items = document.querySelectorAll('.search-item');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      currentFocus++;
      if (currentFocus >= items.length) currentFocus = 0;
      setActive(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      currentFocus--;
      if (currentFocus < 0) currentFocus = items.length - 1;
      setActive(items);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (currentFocus > -1 && items[currentFocus]) {
        window.location.href = items[currentFocus].dataset.url;
      }
    } else if (e.key === 'Escape') {
      searchResults.classList.add('hidden');
      currentFocus = -1;
    }
  });
  
  function setActive(items) {
    items.forEach((item, index) => {
      if (index === currentFocus) {
        item.classList.add('bg-gray-100');
      } else {
        item.classList.remove('bg-gray-100');
      }
    });
  }
  
  // Hide results when clicking outside
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
      searchResults.classList.add('hidden');
    }
  });
</script> 